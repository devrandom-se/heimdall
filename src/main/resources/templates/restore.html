<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Restore</title>
    <style>
        .restore-field { margin-bottom: 1rem; }
        .restore-field .field-warning {
            color: #fe9339;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .restore-field .field-error {
            color: #ea001e;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .restore-field .sandbox-value {
            color: #706e6b;
            font-size: 0.75rem;
            margin-top: 0.15rem;
        }
        .restore-field.has-warning .slds-form-element__label { color: #fe9339; }
        .restore-field.has-error .slds-form-element__label { color: #ea001e; }
        .restore-field.is-readonly .slds-form-element__label { color: #ea001e; }
        .restore-field.is-readonly .slds-form-element__static { color: #ba0517; text-decoration: line-through; }
        .validation-summary { margin-bottom: 1rem; }
        .validation-summary a { cursor: pointer; }
        .lookup-dropdown {
            position: absolute;
            z-index: 9999;
            background: white;
            border: 1px solid #d8dde6;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .lookup-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .lookup-dropdown-item:hover { background: #f3f3f3; }
        .lookup-wrapper { position: relative; }
        .cart-record-card {
            border: 1px solid #d8dde6;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .cart-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f3f3f3;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .cart-record-header.collapsed { border-radius: 4px; }
        .cart-record-body { padding: 1rem; display: none; }
        .cart-record-body.expanded { display: block; }
        .restore-progress { margin-top: 1rem; }
        .restore-progress-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .restore-error-box {
            background: #fef0ef;
            border: 1px solid #ea001e;
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Single Record Mode -->
    <div th:if="${recordId != null}" id="single-mode">
        <div class="slds-page-header slds-page-header_record-home" style="background: white; margin-bottom: 1rem;">
            <div class="slds-page-header__row">
                <div class="slds-page-header__col-title">
                    <div class="slds-page-header__name">
                        <div class="slds-page-header__title slds-truncate" id="page-title">Restore Record</div>
                        <p class="slds-page-header__name-meta">
                            <a th:href="@{/record(id=${recordId})}">&larr; Back to record</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="restore-loading" class="slds-align_absolute-center slds-p-around_large">
            <div class="slds-spinner_container" style="position: relative;">
                <div class="slds-spinner slds-spinner_medium" role="status">
                    <span class="slds-assistive-text">Loading</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                </div>
            </div>
        </div>

        <!-- Form container -->
        <div id="restore-form-container" style="display: none;">
            <!-- Validation Summary -->
            <div id="validation-summary" class="validation-summary" style="display: none;">
                <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                    <span id="validation-summary-text"></span>
                </div>
            </div>

            <!-- Recycle Bin notice -->
            <div id="recycle-bin-notice" style="display: none;">
                <div class="slds-card slds-p-around_large slds-text-align_center">
                    <h3 class="slds-text-heading_medium slds-m-bottom_small">Record is in the Recycle Bin</h3>
                    <p>This record is soft-deleted and can be restored directly from Salesforce with its original ID and relationships intact.</p>
                    <p class="slds-m-top_medium">
                        <a id="recycle-bin-link" href="#" target="_blank" class="slds-button slds-button_brand">Open Recycle Bin in Salesforce</a>
                    </p>
                </div>
            </div>

            <!-- Form -->
            <div id="restore-fields-card" class="slds-card">
                <div class="slds-card__body slds-card__body_inner">
                    <div id="restore-fields"></div>
                </div>
                <div class="slds-card__footer">
                    <a th:href="@{/record(id=${recordId})}" class="slds-button slds-button_neutral">Cancel</a>
                    <button id="restore-btn" class="slds-button slds-button_brand" onclick="submitRestore()">Restore</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Mode -->
    <div th:if="${recordId == null}" id="cart-mode">
        <div class="slds-page-header slds-page-header_record-home" style="background: white; margin-bottom: 1rem;">
            <div class="slds-page-header__row">
                <div class="slds-page-header__col-title">
                    <div class="slds-page-header__name">
                        <div class="slds-page-header__title slds-truncate" id="cart-title">Restore Cart</div>
                    </div>
                </div>
                <div class="slds-page-header__col-actions">
                    <button class="slds-button slds-button_text-destructive" onclick="clearCart()">Clear Cart</button>
                </div>
            </div>
        </div>

        <div id="cart-empty" class="slds-card slds-p-around_large slds-text-align_center" style="display: none;">
            <h3 class="slds-text-heading_medium slds-m-bottom_small">Cart is empty</h3>
            <p>Add records from the <a href="/deleted">Deleted Records</a> or record history pages.</p>
        </div>

        <div id="cart-records"></div>

        <div id="cart-footer" style="display: none;" class="slds-m-top_medium slds-text-align_right">
            <button id="restore-all-btn" class="slds-button slds-button_brand" onclick="restoreAll()">Restore All</button>
        </div>

        <div id="restore-progress" class="restore-progress" style="display: none;"></div>
    </div>

    <script th:inline="javascript">
        var restoreState = {
            recordId: [[${recordId}]],
            period: [[${period}]],
            formData: null
        };

        // Debounce helper
        function debounce(fn, delay) {
            var timer;
            return function() {
                var args = arguments;
                var ctx = this;
                clearTimeout(timer);
                timer = setTimeout(function() { fn.apply(ctx, args); }, delay);
            };
        }

        function escapeHtml(str) {
            if (!str && str !== 0 && str !== false) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(String(str)));
            return div.innerHTML;
        }

        // ===================== Single Record Mode =====================
        if (restoreState.recordId) {
            document.addEventListener('DOMContentLoaded', function() {
                loadRestoreForm(restoreState.recordId, restoreState.period);
            });
        }

        function loadRestoreForm(recordId, period) {
            fetch('/api/restore-form?id=' + encodeURIComponent(recordId) + '&period=' + period)
                .then(function(r) {
                    if (!r.ok) throw new Error('Failed to load form data (HTTP ' + r.status + ')');
                    return r.json();
                })
                .then(function(data) {
                    restoreState.formData = data;
                    document.getElementById('restore-loading').style.display = 'none';
                    document.getElementById('restore-form-container').style.display = '';
                    document.getElementById('page-title').textContent = 'Restore ' + data.objectName + ': ' + (data.recordName || data.recordId);

                    if (data.inRecycleBin && !data.recordExistsInSandbox) {
                        document.getElementById('recycle-bin-notice').style.display = '';
                        document.getElementById('restore-fields-card').style.display = 'none';
                        if (data.lightningUrl) {
                            document.getElementById('recycle-bin-link').href = data.lightningUrl + '/lightning/o/DeleteEvent/list';
                        }
                        return;
                    }

                    renderFields(data, document.getElementById('restore-fields'));

                    if (data.warningCount > 0) {
                        document.getElementById('validation-summary').style.display = '';
                        document.getElementById('validation-summary-text').textContent =
                            data.warningCount + ' field(s) need attention';
                    }
                })
                .catch(function(err) {
                    document.getElementById('restore-loading').style.display = 'none';
                    document.getElementById('restore-form-container').style.display = '';
                    document.getElementById('restore-fields').innerHTML =
                        '<div class="slds-notify slds-notify_alert slds-alert_error">' + escapeHtml(err.message) + '</div>';
                });
        }

        function renderFields(data, container) {
            var editableHtml = '';
            var readOnlyHtml = '';
            var editableCount = 0;
            var readOnlyCount = 0;

            data.fields.forEach(function(f) {
                var extraClass = '';
                if (!f.editable) {
                    extraClass = ' is-readonly';
                } else if (f.validationStatus === 'warning') {
                    extraClass = ' has-warning';
                } else if (f.validationStatus === 'error') {
                    extraClass = ' has-error';
                }

                var fieldHtml = '<div class="restore-field slds-form-element' + extraClass + '" id="field-' + f.name + '">';
                fieldHtml += '<label class="slds-form-element__label" for="input-' + f.name + '">';
                if (f.required && f.editable) {
                    fieldHtml += '<abbr class="slds-required" title="required">*</abbr> ';
                }
                fieldHtml += escapeHtml(f.label);
                if (!f.editable) {
                    fieldHtml += ' <span class="slds-badge" style="background:#ea001e;color:#fff;font-size:0.6rem;vertical-align:middle;">SKIPPED</span>';
                }
                fieldHtml += '</label>';
                fieldHtml += '<div class="slds-form-element__control">';
                fieldHtml += renderFieldInput(f);
                fieldHtml += '</div>';

                if (f.validationMessage) {
                    var cssClass = f.validationStatus === 'error' ? 'field-error' : 'field-warning';
                    fieldHtml += '<div class="' + cssClass + '">' + escapeHtml(f.validationMessage) + '</div>';
                }

                if (f.editable && f.sandboxValue !== null && f.sandboxValue !== undefined) {
                    fieldHtml += '<div class="sandbox-value">Current in sandbox: ' + escapeHtml(String(f.sandboxValue)) + '</div>';
                }

                fieldHtml += '</div>';

                if (f.editable) {
                    editableHtml += fieldHtml;
                    editableCount++;
                } else {
                    readOnlyHtml += fieldHtml;
                    readOnlyCount++;
                }
            });

            var html = '<div class="slds-box slds-box_x-small slds-m-bottom_medium" style="background:#f3f3f3;">' +
                '<strong>' + editableCount + '</strong> fields will be sent &nbsp;|&nbsp; ' +
                '<span style="color:#ea001e;"><strong>' + readOnlyCount + '</strong> fields skipped (not writable)</span></div>';
            html += editableHtml;
            if (readOnlyCount > 0) {
                html += '<details class="slds-m-top_medium" style="border-top:2px solid #ea001e;padding-top:0.75rem;">' +
                    '<summary style="cursor:pointer;color:#ea001e;font-size:0.85rem;font-weight:bold;">' +
                    readOnlyCount + ' fields will NOT be sent (not createable/updateable)</summary>' +
                    '<div class="slds-m-top_small">' + readOnlyHtml + '</div></details>';
            }
            container.innerHTML = html;

            // Attach lookup search handlers
            data.fields.forEach(function(f) {
                if (f.type === 'reference' && f.editable) {
                    attachLookupHandler(f);
                }
            });
        }

        function renderFieldInput(f) {
            var val = f.backupValue !== null && f.backupValue !== undefined ? String(f.backupValue) : '';

            if (!f.editable) {
                return '<span class="slds-form-element__static">' + escapeHtml(val) + '</span>';
            }

            var type = (f.type || 'string').toLowerCase();

            if (type === 'reference') {
                var refLabel = '';
                if (f.referenceTo && f.referenceTo.length > 1) {
                    refLabel = ' <span class="slds-badge" style="font-size:0.65rem;">Polymorphic</span>';
                }
                return '<div class="lookup-wrapper">' +
                    '<input type="text" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">' +
                    refLabel +
                    (f.referenceTo && f.referenceTo.length === 1 ?
                        '<button type="button" class="slds-button slds-button_icon" onclick="toggleLookupSearch(\'' + f.name + '\')" title="Search" style="position:absolute;right:0.5rem;top:0.25rem;">' +
                        '<svg class="slds-button__icon" aria-hidden="true" viewBox="0 0 52 52" style="width:1rem;height:1rem;">' +
                        '<path fill="currentColor" d="M49.6 45.3L38 33.8c2.4-3.4 3.8-7.5 3.8-12C41.8 10.3 32.5 1 21 1S.2 10.3.2 21.8s9.3 20.8 20.8 20.8c4.5 0 8.6-1.4 12-3.8l11.7 11.5c.6.6 1.4.6 2 0l2.9-2.9c.5-.7.5-1.5 0-2.1zM21 36.7c-8.2 0-14.9-6.7-14.9-14.9S12.8 6.9 21 6.9s14.9 6.7 14.9 14.9-6.7 14.9-14.9 14.9z"/>' +
                        '</svg></button>' +
                        '<div class="lookup-dropdown" id="lookup-dd-' + f.name + '" style="display:none;"></div>' : '') +
                    '</div>';
            }

            if (type === 'picklist') {
                var opts = '<option value="">-- None --</option>';
                if (f.picklistValues) {
                    // Add backup value as option if not in active list
                    var found = false;
                    f.picklistValues.forEach(function(pv) {
                        if (pv.value === val) found = true;
                    });
                    if (val && !found) {
                        opts += '<option value="' + escapeHtml(val) + '" style="color:#fe9339;">' + escapeHtml(val) + ' (inactive)</option>';
                    }
                    f.picklistValues.forEach(function(pv) {
                        var selected = pv.value === val ? ' selected' : '';
                        var style = pv.active ? '' : ' style="color:#706e6b;"';
                        opts += '<option value="' + escapeHtml(pv.value) + '"' + selected + style + '>' + escapeHtml(pv.label || pv.value) + (pv.active ? '' : ' (inactive)') + '</option>';
                    });
                }
                return '<div class="slds-select_container"><select class="slds-select" id="input-' + f.name + '" name="' + f.name + '">' + opts + '</select></div>';
            }

            if (type === 'multipicklist') {
                var selected = val ? val.split(';').map(function(v) { return v.trim(); }) : [];
                var opts = '';
                if (f.picklistValues) {
                    // Add backup values that are not in the active list
                    var knownValues = new Set();
                    f.picklistValues.forEach(function(pv) { knownValues.add(pv.value); });
                    selected.forEach(function(sv) {
                        if (sv && !knownValues.has(sv)) {
                            opts += '<option value="' + escapeHtml(sv) + '" selected style="color:#fe9339;">' + escapeHtml(sv) + ' (inactive)</option>';
                        }
                    });
                    f.picklistValues.forEach(function(pv) {
                        var sel = selected.indexOf(pv.value) >= 0 ? ' selected' : '';
                        opts += '<option value="' + escapeHtml(pv.value) + '"' + sel + '>' + escapeHtml(pv.label || pv.value) + (pv.active ? '' : ' (inactive)') + '</option>';
                    });
                }
                return '<select class="slds-select" id="input-' + f.name + '" name="' + f.name + '" multiple size="4">' + opts + '</select>';
            }

            if (type === 'boolean') {
                var checked = (val === 'true' || val === '1') ? ' checked' : '';
                return '<label class="slds-checkbox_toggle slds-grid">' +
                    '<input type="checkbox" id="input-' + f.name + '" name="' + f.name + '"' + checked + '>' +
                    '<span class="slds-checkbox_faux_container slds-m-left_x-small">' +
                    '<span class="slds-checkbox_faux"></span>' +
                    '</span></label>';
            }

            if (type === 'date') {
                return '<input type="date" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
            }

            if (type === 'datetime') {
                var dtVal = val;
                if (dtVal && dtVal.indexOf('T') > 0) {
                    dtVal = dtVal.substring(0, 16); // trim to yyyy-MM-ddTHH:mm
                }
                return '<input type="datetime-local" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(dtVal) + '">';
            }

            if (type === 'int' || type === 'double' || type === 'currency' || type === 'percent') {
                var step = (type === 'int') ? '1' : 'any';
                return '<input type="number" step="' + step + '" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
            }

            if (type === 'email') {
                return '<input type="email" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
            }

            if (type === 'url') {
                return '<input type="url" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
            }

            if (type === 'phone') {
                return '<input type="tel" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
            }

            if (type === 'textarea' || type === 'encryptedstring') {
                return '<textarea class="slds-textarea" id="input-' + f.name + '" name="' + f.name + '" rows="3">' + escapeHtml(val) + '</textarea>';
            }

            // Default: text input
            return '<input type="text" class="slds-input" id="input-' + f.name + '" name="' + f.name + '" value="' + escapeHtml(val) + '">';
        }

        // Lookup search
        function toggleLookupSearch(fieldName) {
            var dd = document.getElementById('lookup-dd-' + fieldName);
            if (dd.style.display === 'none') {
                dd.style.display = '';
                dd.innerHTML = '<div class="lookup-dropdown-item" style="color:#706e6b;">Type to search...</div>';
                var input = document.getElementById('input-' + fieldName);
                input.focus();
            } else {
                dd.style.display = 'none';
            }
        }

        function attachLookupHandler(field) {
            var input = document.getElementById('input-' + field.name);
            if (!input) return;
            var refType = field.referenceTo && field.referenceTo.length === 1 ? field.referenceTo[0] : null;
            if (!refType) return;

            var doSearch = debounce(function() {
                var term = input.value.trim();
                if (term.length < 2) return;

                // If it looks like a Salesforce ID, don't search
                if (/^[a-zA-Z0-9]{15,18}$/.test(term)) return;

                var dd = document.getElementById('lookup-dd-' + field.name);
                dd.style.display = '';
                dd.innerHTML = '<div class="lookup-dropdown-item" style="color:#706e6b;">Searching...</div>';

                fetch('/api/lookup-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ objectName: refType, searchTerm: term })
                })
                .then(function(r) { return r.json(); })
                .then(function(results) {
                    if (results.length === 0) {
                        dd.innerHTML = '<div class="lookup-dropdown-item" style="color:#706e6b;">No results</div>';
                        return;
                    }
                    var html = '';
                    results.forEach(function(r) {
                        html += '<div class="lookup-dropdown-item" onclick="selectLookup(\'' + field.name + '\',\'' + escapeHtml(r.id) + '\',\'' + escapeHtml(r.name) + '\')">' +
                            '<strong>' + escapeHtml(r.name) + '</strong> <span style="color:#706e6b;">' + escapeHtml(r.id) + '</span></div>';
                    });
                    dd.innerHTML = html;
                })
                .catch(function() {
                    dd.innerHTML = '<div class="lookup-dropdown-item" style="color:#ea001e;">Search failed</div>';
                });
            }, 300);

            input.addEventListener('input', doSearch);

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                var dd = document.getElementById('lookup-dd-' + field.name);
                if (dd && !dd.contains(e.target) && e.target !== input) {
                    dd.style.display = 'none';
                }
            });
        }

        function selectLookup(fieldName, id, name) {
            document.getElementById('input-' + fieldName).value = id;
            document.getElementById('lookup-dd-' + fieldName).style.display = 'none';
            // Clear warning
            var fieldDiv = document.getElementById('field-' + fieldName);
            if (fieldDiv) {
                fieldDiv.classList.remove('has-warning');
                var warn = fieldDiv.querySelector('.field-warning');
                if (warn) warn.style.display = 'none';
            }
        }

        function getWarningFields(data) {
            var warnings = [];
            data.fields.forEach(function(f) {
                if (f.validationStatus === 'warning' && f.editable) {
                    warnings.push(f);
                }
            });
            return warnings;
        }

        function showRestoreError(message, data, skippedFields) {
            var errorDiv = document.getElementById('restore-error');
            if (!errorDiv) {
                var container = document.getElementById('restore-fields-card');
                var div = document.createElement('div');
                div.id = 'restore-error';
                container.insertBefore(div, container.firstChild);
                errorDiv = div;
            }

            var html = '<div class="slds-notify slds-notify_alert slds-alert_error slds-m-around_small" role="alert">' +
                '<strong>Restore failed:</strong> ' + escapeHtml(message) + '</div>';

            if (skippedFields && skippedFields.length > 0) {
                html += '<div class="slds-box slds-box_x-small slds-m-around_small" style="background:#e1f5fe;border-color:#0070d2;">' +
                    '<p class="slds-text-title_bold" style="color:#0070d2;">' + skippedFields.length +
                    ' reference field(s) were already auto-skipped before sending:</p><ul style="margin:0.5rem 0 0 1.5rem;">';
                skippedFields.forEach(function(s) {
                    html += '<li>' + escapeHtml(s) + '</li>';
                });
                html += '</ul></div>';
            }

            if (data) {
                var warnings = getWarningFields(data);
                if (warnings.length > 0) {
                    html += '<div class="slds-box slds-box_x-small slds-m-around_small" style="background:#fff8e1;border-color:#fe9339;">' +
                        '<p class="slds-text-title_bold" style="color:#fe9339;">These fields may also be causing the issue:</p><ul style="margin:0.5rem 0 0 1.5rem;">';
                    warnings.forEach(function(f) {
                        html += '<li><strong>' + escapeHtml(f.label) + '</strong> (' + escapeHtml(f.name) + '): ' + escapeHtml(f.validationMessage) + '</li>';
                    });
                    html += '</ul><p class="slds-m-top_small">Clear or fix these fields above, then try again.</p></div>';
                }
            }
            errorDiv.innerHTML = html;
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearRestoreError() {
            var errorDiv = document.getElementById('restore-error');
            if (errorDiv) errorDiv.innerHTML = '';
        }

        // Submit restore
        function submitRestore() {
            var data = restoreState.formData;
            if (!data) return;
            clearRestoreError();

            var fieldValues = collectFieldValues(data);

            // Pre-submit check: warn about fields with validation issues
            var warnings = getWarningFields(data);
            if (warnings.length > 0) {
                var fieldNames = warnings.map(function(f) { return f.label + ' (' + f.name + ')'; }).join('\n  - ');
                var msg = 'The following fields have validation warnings:\n  - ' + fieldNames +
                    '\n\nYou can:\n' +
                    '- Click OK to restore anyway (may fail)\n' +
                    '- Click Cancel, then fix or clear those fields above';
                if (!confirm(msg)) return;
            } else {
                if (!confirm('Restore ' + data.objectName + ': ' + (data.recordName || data.recordId) + '?')) return;
            }

            var btn = document.getElementById('restore-btn');
            btn.disabled = true;
            btn.textContent = 'Restoring...';

            fetch('/api/restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    recordId: data.recordId,
                    period: data.period,
                    fieldValues: fieldValues
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.success) {
                    var html = '<div class="slds-align_absolute-center slds-p-around_large slds-text-color_success">' +
                        '<strong>Restored successfully!</strong><br>Record ID: ' + escapeHtml(result.newId) + '</div>';
                    if (result.skippedFields && result.skippedFields.length > 0) {
                        html += '<div class="slds-box slds-box_x-small slds-m-around_medium" style="background:#fff8e1;border-color:#fe9339;">' +
                            '<p class="slds-text-title_bold" style="color:#fe9339;">' + result.skippedFields.length +
                            ' reference field(s) were auto-skipped (invalid references):</p><ul style="margin:0.5rem 0 0 1.5rem;">';
                        result.skippedFields.forEach(function(s) {
                            html += '<li>' + escapeHtml(s) + '</li>';
                        });
                        html += '</ul></div>';
                    }
                    document.getElementById('restore-fields').innerHTML = html;
                    btn.style.display = 'none';
                    clearRestoreError();
                } else {
                    showRestoreError(result.error, data, result.skippedFields);
                    btn.disabled = false;
                    btn.textContent = 'Restore';
                }
            })
            .catch(function(err) {
                showRestoreError(String(err), data);
                btn.disabled = false;
                btn.textContent = 'Restore';
            });
        }

        function collectFieldValues(data) {
            var values = {};
            data.fields.forEach(function(f) {
                if (!f.editable) return;

                var input = document.getElementById('input-' + f.name);
                if (!input) return;

                var type = (f.type || 'string').toLowerCase();

                if (type === 'boolean') {
                    values[f.name] = input.checked;
                } else if (type === 'multipicklist') {
                    var selected = [];
                    for (var i = 0; i < input.options.length; i++) {
                        if (input.options[i].selected) selected.push(input.options[i].value);
                    }
                    values[f.name] = selected.join(';');
                } else {
                    var val = input.value;
                    if (type === 'int') {
                        values[f.name] = val ? parseInt(val, 10) : null;
                    } else if (type === 'double' || type === 'currency' || type === 'percent') {
                        values[f.name] = val ? parseFloat(val) : null;
                    } else if (type === 'datetime' && val) {
                        // Convert local datetime to ISO with Z suffix
                        values[f.name] = val + ':00.000Z';
                    } else {
                        values[f.name] = val || null;
                    }
                }
            });
            return values;
        }

        // ===================== Cart Mode =====================
        if (!restoreState.recordId) {
            document.addEventListener('DOMContentLoaded', function() {
                renderCart();
            });
        }

        function renderCart() {
            var items = heimdallCart.getItems();
            var container = document.getElementById('cart-records');
            var footer = document.getElementById('cart-footer');
            var emptyMsg = document.getElementById('cart-empty');

            document.getElementById('cart-title').textContent = 'Restore Cart (' + items.length + ' records)';

            if (items.length === 0) {
                emptyMsg.style.display = '';
                footer.style.display = 'none';
                container.innerHTML = '';
                return;
            }

            emptyMsg.style.display = 'none';
            footer.style.display = '';

            var html = '';
            items.forEach(function(item, idx) {
                html += '<div class="cart-record-card" id="cart-item-' + idx + '">' +
                    '<div class="cart-record-header collapsed" onclick="toggleCartItem(' + idx + ')">' +
                    '<span><strong>' + escapeHtml(item.objectName) + '</strong>: ' + escapeHtml(item.name || item.id) + '</span>' +
                    '<span>' +
                    '<span class="slds-badge" id="cart-status-' + idx + '">Pending</span> ' +
                    '<button class="slds-button slds-button_icon slds-button_icon-error" onclick="event.stopPropagation(); removeCartItem(' + idx + ')" title="Remove">' +
                    '<svg class="slds-button__icon" aria-hidden="true" viewBox="0 0 52 52" style="width:0.875rem;height:0.875rem;">' +
                    '<path fill="currentColor" d="M31 25.4l13-13c.6-.6.6-1.6 0-2.1l-2.1-2.1c-.6-.6-1.6-.6-2.1 0L26.4 21.6c-.4.4-1 .4-1.4 0L11.4 8.2c-.6-.6-1.5-.6-2.1 0L7.2 10.3c-.6.6-.6 1.5 0 2.1l13.5 13.4c.4.4.4 1 0 1.4L7.2 40.6c-.6.6-.6 1.5 0 2.1l2.1 2.1c.6.6 1.5.6 2.1 0l13.4-13.4c.4-.4 1-.4 1.4 0l13.5 13.4c.6.6 1.5.6 2.1 0l2.1-2.1c.6-.6.6-1.5 0-2.1L31 26.8c-.5-.4-.5-1-.1-1.4z"/>' +
                    '</svg></button>' +
                    '</span>' +
                    '</div>' +
                    '<div class="cart-record-body" id="cart-body-' + idx + '">' +
                    '<div class="slds-align_absolute-center slds-p-around_medium">Loading form data...</div>' +
                    '</div>' +
                    '</div>';
            });
            container.innerHTML = html;

            // Load form data for each cart item
            items.forEach(function(item, idx) {
                loadCartItemForm(item, idx);
            });
        }

        function toggleCartItem(idx) {
            var body = document.getElementById('cart-body-' + idx);
            var header = body.previousElementSibling;
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                header.classList.add('collapsed');
            } else {
                body.classList.add('expanded');
                header.classList.remove('collapsed');
            }
        }

        function removeCartItem(idx) {
            var items = heimdallCart.getItems();
            if (idx >= 0 && idx < items.length) {
                heimdallCart.removeItem(items[idx].id);
                renderCart();
            }
        }

        var cartFormData = {};

        function loadCartItemForm(item, idx) {
            fetch('/api/restore-form?id=' + encodeURIComponent(item.id) + '&period=' + item.period)
                .then(function(r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(function(data) {
                    cartFormData[idx] = data;
                    var body = document.getElementById('cart-body-' + idx);

                    // Prefix field IDs with cart index to avoid collisions
                    var prefixedData = JSON.parse(JSON.stringify(data));
                    prefixedData.fields.forEach(function(f) {
                        f._originalName = f.name;
                        f.name = 'cart' + idx + '_' + f.name;
                    });

                    renderFields(prefixedData, body);

                    if (data.warningCount > 0) {
                        document.getElementById('cart-status-' + idx).textContent = data.warningCount + ' warning(s)';
                        document.getElementById('cart-status-' + idx).className = 'slds-badge slds-badge_warning';
                    }

                    // Re-attach lookup handlers with prefixed names
                    prefixedData.fields.forEach(function(f) {
                        if (f.type === 'reference' && f.editable) {
                            attachLookupHandler(f);
                        }
                    });
                })
                .catch(function(err) {
                    document.getElementById('cart-body-' + idx).innerHTML =
                        '<div class="slds-text-color_error slds-p-around_medium">Failed to load: ' + escapeHtml(err.message) + '</div>';
                });
        }

        function collectCartFieldValues(idx) {
            var data = cartFormData[idx];
            if (!data) return null;

            var values = {};
            data.fields.forEach(function(f) {
                if (!f.editable) return;

                var inputId = 'input-cart' + idx + '_' + f.name;
                var input = document.getElementById(inputId);
                if (!input) return;

                var type = (f.type || 'string').toLowerCase();

                if (type === 'boolean') {
                    values[f.name] = input.checked;
                } else if (type === 'multipicklist') {
                    var selected = [];
                    for (var i = 0; i < input.options.length; i++) {
                        if (input.options[i].selected) selected.push(input.options[i].value);
                    }
                    values[f.name] = selected.join(';');
                } else {
                    var val = input.value;
                    if (type === 'int') {
                        values[f.name] = val ? parseInt(val, 10) : null;
                    } else if (type === 'double' || type === 'currency' || type === 'percent') {
                        values[f.name] = val ? parseFloat(val) : null;
                    } else if (type === 'datetime' && val) {
                        values[f.name] = val + ':00.000Z';
                    } else {
                        values[f.name] = val || null;
                    }
                }
            });
            return values;
        }

        function clearCart() {
            if (!confirm('Clear all records from the restore cart?')) return;
            heimdallCart.clear();
            renderCart();
        }

        function restoreAll() {
            var items = heimdallCart.getItems();
            if (items.length === 0) return;
            if (!confirm('Restore ' + items.length + ' record(s)?')) return;

            var btn = document.getElementById('restore-all-btn');
            btn.disabled = true;
            btn.textContent = 'Restoring...';

            restoreSequentially(items, 0);
        }

        function restoreSequentially(items, idx) {
            if (idx >= items.length) {
                document.getElementById('restore-all-btn').textContent = 'Done!';
                return;
            }

            var item = items[idx];
            var statusBadge = document.getElementById('cart-status-' + idx);
            statusBadge.textContent = 'Restoring...';
            statusBadge.className = 'slds-badge';

            var fieldValues = collectCartFieldValues(idx);

            fetch('/api/restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    recordId: item.id,
                    period: item.period,
                    fieldValues: fieldValues
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.success) {
                    var msg = 'Restored: ' + result.newId;
                    if (result.skippedFields && result.skippedFields.length > 0) {
                        msg += ' (' + result.skippedFields.length + ' refs skipped)';
                    }
                    statusBadge.textContent = msg;
                    statusBadge.className = 'slds-badge slds-badge_success';
                    heimdallCart.removeItem(item.id);
                } else {
                    statusBadge.textContent = 'Failed: ' + result.error;
                    statusBadge.className = 'slds-badge slds-badge_error';
                }
                restoreSequentially(items, idx + 1);
            })
            .catch(function(err) {
                statusBadge.textContent = 'Error';
                statusBadge.className = 'slds-badge slds-badge_error';
                restoreSequentially(items, idx + 1);
            });
        }
    </script>
</div>
</body>
</html>
