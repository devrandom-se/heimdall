<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title th:text="'Record ' + ${recordId}">Record History</title>
    <style>
        .diff-added { background-color: #d4edda; }
        .diff-removed { background-color: #f8d7da; }
        .diff-changed { background-color: #fff3cd; }
        .version-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .version-card {
            border-left: 4px solid #0176d3;
            margin-bottom: 0.5rem;
        }
        .version-card.selected {
            border-left-color: #2e844a;
            background-color: #f3f3f3;
        }
        .period-archive {
            font-style: italic;
            color: #706e6b;
        }
        .slds-badge_success {
            background-color: #2e844a;
            color: #fff;
        }
        .slds-badge_archive {
            background-color: #706e6b;
            color: #fff;
        }
        .slds-modal { pointer-events: none; }
        .slds-backdrop { pointer-events: none; }
        .slds-modal.slds-fade-in-open { pointer-events: auto; }
        .slds-backdrop.slds-backdrop_open { pointer-events: auto; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <div class="slds-page-header slds-page-header_record-home" style="background: white; margin-bottom: 1rem;">
        <div class="slds-page-header__row">
            <div class="slds-page-header__col-title">
                <div class="slds-page-header__name">
                    <div class="slds-page-header__title slds-truncate">
                        <span th:text="${objectName}">Object</span>:
                        <span th:text="${recordName}">Name</span>
                    </div>
                    <p class="slds-page-header__name-meta" th:text="'ID: ' + ${recordId}">ID</p>
                </div>
            </div>
            <div class="slds-page-header__col-actions">
                <span th:if="${recordStatus != null && recordStatus.isActive()}" class="slds-badge slds-badge_success slds-m-right_xx-small">ACTIVE</span>
                <span th:if="${recordStatus != null && recordStatus.isDeleted()}" class="slds-badge slds-badge_error slds-m-right_xx-small">DELETED</span>
                <span th:if="${recordStatus != null && recordStatus.isArchived()}" class="slds-badge slds-badge_archive">ARCHIVED</span>
            </div>
        </div>
    </div>

    <!-- Not Found Message -->
    <div class="slds-card" th:if="${versions == null || versions.isEmpty()}">
        <div class="slds-card__body slds-card__body_inner slds-text-align_center slds-p-around_large">
            <div class="slds-illustration slds-illustration_small">
                <svg class="slds-illustration__svg" viewBox="0 0 468 194" aria-hidden="true" style="width: 200px; height: 100px;">
                    <path d="M234 97c51.915 0 94-42.085 94-94H140c0 51.915 42.085 94 94 94z" fill="#EEF1F6"/>
                </svg>
            </div>
            <h3 class="slds-text-heading_medium slds-m-bottom_small">No Record Found</h3>
            <p th:text="'No backup data found for record ID: ' + ${recordId}">Message</p>
        </div>
    </div>

    <!-- Version Timeline -->
    <div class="slds-grid slds-gutters" th:if="${versions != null && !versions.isEmpty()}">
        <!-- Left: Version List -->
        <div class="slds-col slds-size_1-of-3">
            <div class="slds-card">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Versions (<span th:text="${versions.size()}">0</span>)</h2>
                </div>
                <div class="slds-card__body">
                    <ul class="slds-has-dividers_bottom-space">
                        <li th:each="version, iter : ${versions}" class="slds-item">
                            <div class="slds-box slds-box_x-small version-card"
                                 th:classappend="${iter.index == selectedVersionIndex} ? 'selected'">
                                <a th:href="@{/record(id=${recordId}, v=${iter.index})}" class="slds-text-link_reset">
                                    <p class="slds-text-title_bold" th:text="'Version ' + (${versions.size()} - ${iter.index})">Version</p>
                                    <p class="slds-text-body_small"
                                       th:classappend="${version.archivePeriod} ? 'period-archive'"
                                       th:text="${version.formattedPeriod}">Period</p>
                                    <span th:if="${version.isDeleted}" class="slds-badge slds-badge_error slds-m-top_xx-small">Deleted</span>
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Restore History -->
            <div class="slds-card slds-m-top_small" th:if="${restoreHistory != null && !restoreHistory.isEmpty()}">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Restore History</h2>
                </div>
                <div class="slds-card__body">
                    <ul class="slds-has-dividers_bottom-space">
                        <li th:each="rh : ${restoreHistory}" class="slds-item">
                            <div class="slds-box slds-box_x-small" style="border-left: 4px solid #0176d3;">
                                <p class="slds-text-body_small slds-text-title_bold" th:text="${rh.sandboxName}">sandbox</p>
                                <p th:if="${rh.createdNew}" class="slds-text-body_small">Created as <span th:text="${rh.newId}">id</span></p>
                                <p th:unless="${rh.createdNew}" class="slds-text-body_small">Updated fields: <span th:text="${rh.restoredFields}">fields</span></p>
                                <p class="slds-text-body_small" style="color: #706e6b;" th:text="${rh.formattedDate}">date</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right: Version Details & Diff -->
        <div class="slds-col slds-size_2-of-3">
            <!-- Current Version Details -->
            <div class="slds-card slds-m-bottom_medium">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                <span th:text="'Version ' + (${versions.size()} - ${selectedVersionIndex}) + ' Details'">Version Details</span>
                            </h2>
                        </div>
                    </header>
                    <div class="slds-no-flex">
                        <a th:if="${isContentVersion != null && isContentVersion && hasDownloadableFile != null && hasDownloadableFile}"
                           th:href="@{/api/download-url(id=${recordId})}"
                           class="slds-button slds-button_neutral slds-m-right_x-small"
                           target="_blank">
                            Download File
                        </a>
                        <button class="slds-button slds-button_neutral add-to-cart-btn"
                                th:data-record-id="${recordId}"
                                th:data-period="${selectedVersion.period}"
                                th:data-object-name="${objectName}"
                                th:data-record-name="${recordName}">
                            Add to Restore
                        </button>
                        <a th:href="@{/restore(id=${recordId}, period=${selectedVersion.period})}"
                           class="slds-button slds-button_neutral">
                            Restore with Changes
                        </a>
                        <button class="slds-button slds-button_brand compare-btn"
                                th:data-record-id="${recordId}"
                                th:data-period="${selectedVersion.period}">
                            Compare with Salesforce
                        </button>
                    </div>
                </div>
                <div class="slds-card__body">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 30%"><div class="slds-truncate">Field</div></th>
                                <th scope="col"><div class="slds-truncate">Value</div></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="entry : ${selectedVersion.metadata}">
                                <td class="slds-text-title_bold" th:text="${entry.key}">Field</td>
                                <td style="white-space: pre-wrap; word-break: break-word;" th:text="${entry.value}">Value</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Diff with Previous Version -->
            <div class="slds-card" th:if="${diff != null && !diff.isEmpty()}">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">Changes from Previous Version</h2>
                </div>
                <div class="slds-card__body">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 25%"><div class="slds-truncate">Field</div></th>
                                <th scope="col" style="width: 37.5%"><div class="slds-truncate">Previous Value</div></th>
                                <th scope="col" style="width: 37.5%"><div class="slds-truncate">New Value</div></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="change : ${diff}" th:classappend="${change.type}">
                                <td class="slds-text-title_bold" th:text="${change.field}">Field</td>
                                <td style="white-space: pre-wrap; word-break: break-word;" th:text="${change.oldValue}">Old</td>
                                <td style="white-space: pre-wrap; word-break: break-word;" th:text="${change.newValue}">New</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Related Files -->
            <div class="slds-card slds-m-top_medium" th:if="${relatedFiles != null && !relatedFiles.isEmpty()}">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-doctype-attachment" title="Files" style="background-color: #747474;">
                                <svg class="slds-icon slds-icon_small" aria-hidden="true" viewBox="0 0 56 64">
                                    <path fill="#fff" d="M30.67 0H5.33C2.4 0 0 2.4 0 5.33v53.34C0 61.6 2.4 64 5.33 64h45.34C53.6 64 56 61.6 56 58.67V25.33L30.67 0z" fill-opacity=".1"/>
                                    <path fill="#fff" d="M38.4 37.87l-9.07 9.06c-2.64 2.64-6.93 2.64-9.57 0-2.64-2.64-2.64-6.93 0-9.57l12.27-12.26c1.6-1.6 4.18-1.6 5.78 0 1.6 1.6 1.6 4.18 0 5.78L26.13 42.56c-.53.53-1.4.53-1.93 0s-.53-1.4 0-1.93l9.07-9.07c.53-.53.53-1.4 0-1.93-.53-.53-1.4-.53-1.93 0l-9.07 9.07c-1.6 1.6-1.6 4.18 0 5.78 1.6 1.6 4.18 1.6 5.78 0L39.73 33.8c2.64-2.64 2.64-6.93 0-9.57-2.64-2.64-6.93-2.64-9.57 0L17.9 36.5c-3.73 3.73-3.73 9.78 0 13.5 3.73 3.73 9.78 3.73 13.5 0l9.07-9.06c.53-.53.53-1.4 0-1.93-.54-.54-1.54-.54-2.07-.14z"/>
                                </svg>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <h2 class="slds-card__header-title">
                                Related Files (<span th:text="${relatedFiles.size()}">0</span>)
                            </h2>
                        </div>
                    </header>
                </div>
                <div class="slds-card__body">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                        <thead>
                            <tr>
                                <th scope="col"><div class="slds-truncate">File Name</div></th>
                                <th scope="col" style="width: 10%"><div class="slds-truncate">Type</div></th>
                                <th scope="col" style="width: 10%"><div class="slds-truncate">Extension</div></th>
                                <th scope="col" style="width: 12%"><div class="slds-truncate">Size</div></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="file : ${relatedFiles}">
                                <td>
                                    <a th:href="@{/record(id=${file.contentVersionId})}" th:text="${file.name}">File Name</a>
                                </td>
                                <td th:text="${file.fileType}">Type</td>
                                <td th:text="${file.fileExtension}">Ext</td>
                                <td th:text="${file.formattedSize}">Size</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Related Child Records -->
            <div th:if="${groupedRelatedRecords != null && !groupedRelatedRecords.isEmpty()}">
                <div th:each="group : ${groupedRelatedRecords}" class="slds-card slds-m-top_medium">
                    <div class="slds-card__header">
                        <h2 class="slds-card__header-title">
                            <span th:text="${group.key}">ObjectName</span>
                            (<span th:text="${group.value.size()}">0</span>)
                        </h2>
                    </div>
                    <div class="slds-card__body">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                            <thead>
                                <tr>
                                    <th scope="col"><div class="slds-truncate">Name</div></th>
                                    <th scope="col" style="width: 25%"><div class="slds-truncate">Record ID</div></th>
                                    <th scope="col" style="width: 15%"><div class="slds-truncate">Referencing Field</div></th>
                                    <th scope="col" style="width: 15%"><div class="slds-truncate">Status</div></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="rec : ${group.value}">
                                    <td th:text="${rec.name}">Name</td>
                                    <td>
                                        <a th:href="@{/record(id=${rec.id})}" th:text="${rec.id}">ID</a>
                                    </td>
                                    <td th:text="${rec.referencingField}">Field</td>
                                    <td>
                                        <span th:if="${rec.isActive()}" class="slds-badge slds-badge_success slds-m-right_xx-small">ACTIVE</span>
                                        <span th:if="${rec.isDeleted()}" class="slds-badge slds-badge_error slds-m-right_xx-small">DELETED</span>
                                        <span th:if="${rec.isArchived()}" class="slds-badge slds-badge_archive">ARCHIVED</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare/Restore Modal -->
    <section id="compare-modal" role="dialog" tabindex="-1" class="slds-modal" aria-modal="true">
        <div class="slds-modal__container" style="max-width: 80vw; width: 80vw;">
            <header class="slds-modal__header">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" onclick="closeCompareModal()">
                    <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true" viewBox="0 0 52 52">
                        <path fill="currentColor" d="M31 25.4l13-13c.6-.6.6-1.6 0-2.1l-2.1-2.1c-.6-.6-1.6-.6-2.1 0L26.4 21.6c-.4.4-1 .4-1.4 0L11.4 8.2c-.6-.6-1.5-.6-2.1 0L7.2 10.3c-.6.6-.6 1.5 0 2.1l13.5 13.4c.4.4.4 1 0 1.4L7.2 40.6c-.6.6-.6 1.5 0 2.1l2.1 2.1c.6.6 1.5.6 2.1 0l13.4-13.4c.4-.4 1-.4 1.4 0l13.5 13.4c.6.6 1.5.6 2.1 0l2.1-2.1c.6-.6.6-1.5 0-2.1L31 26.8c-.5-.4-.5-1-.1-1.4z"/>
                    </svg>
                </button>
                <h2 class="slds-modal__title" id="compare-modal-title">Compare with Salesforce</h2>
            </header>
            <div class="slds-modal__content slds-p-around_medium" id="compare-modal-body">
                <div class="slds-spinner_container">
                    <div class="slds-spinner slds-spinner_medium" role="status">
                        <span class="slds-assistive-text">Loading</span>
                        <div class="slds-spinner__dot-a"></div>
                        <div class="slds-spinner__dot-b"></div>
                    </div>
                </div>
            </div>
            <footer class="slds-modal__footer">
                <button class="slds-button slds-button_neutral" id="compare-close-btn" onclick="closeCompareModal()">Cancel</button>
                <button class="slds-button slds-button_brand" id="restore-selected-btn" style="display:none;" onclick="restoreSelected()">Restore Selected Fields</button>
            </footer>
        </div>
    </section>
    <div id="compare-backdrop" class="slds-backdrop"></div>

    <script>
        var compareState = {};

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.compare-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    compareState.recordId = this.dataset.recordId;
                    compareState.period = this.dataset.period;
                    openCompareModal();
                });
            });

            // Render HtmlBody fields as sandboxed iframes
            document.querySelectorAll('table.slds-table tbody tr').forEach(function(row) {
                var fieldCell = row.querySelector('td:first-child');
                var valueCell = row.querySelector('td:nth-child(2)');
                if (fieldCell && valueCell && fieldCell.textContent.trim() === 'HtmlBody') {
                    var htmlContent = valueCell.textContent;
                    var iframe = document.createElement('iframe');
                    iframe.sandbox = '';
                    iframe.style.width = '100%';
                    iframe.style.border = 'none';
                    iframe.style.overflow = 'hidden';
                    iframe.srcdoc = htmlContent;
                    iframe.onload = function() {
                        try {
                            iframe.style.height = iframe.contentDocument.documentElement.scrollHeight + 'px';
                        } catch(e) {
                            iframe.style.height = '300px';
                        }
                    };
                    valueCell.textContent = '';
                    valueCell.style.whiteSpace = 'normal';
                    valueCell.appendChild(iframe);
                }
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    heimdallCart.addItem({
                        id: this.dataset.recordId,
                        period: parseInt(this.dataset.period),
                        objectName: this.dataset.objectName,
                        name: this.dataset.recordName
                    });
                    this.textContent = 'Added!';
                    this.disabled = true;
                    var self = this;
                    setTimeout(function() { self.textContent = 'Add to Restore'; self.disabled = false; }, 1500);
                });
            });
        });

        function openCompareModal() {
            document.getElementById('compare-modal').classList.add('slds-fade-in-open');
            document.getElementById('compare-backdrop').classList.add('slds-backdrop_open');
            document.getElementById('compare-modal-body').innerHTML =
                '<div class="slds-align_absolute-center slds-p-around_large">Loading comparison...</div>';
            document.getElementById('restore-selected-btn').style.display = 'none';
            document.getElementById('compare-close-btn').textContent = 'Cancel';

            fetch('/api/compare', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recordId: compareState.recordId, period: compareState.period })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    document.getElementById('compare-modal-body').innerHTML =
                        '<div class="slds-notify slds-notify_alert slds-alert_error" role="alert">' + data.error + '</div>';
                    return;
                }

                compareState.objectName = data.objectName;
                compareState.recordExists = data.recordExists;
                compareState.inRecycleBin = data.inRecycleBin;

                if (data.recordExists) {
                    // Record exists — show diff with checkboxes for selective restore
                    if (data.diff.length === 0) {
                        document.getElementById('compare-modal-body').innerHTML =
                            '<div class="slds-align_absolute-center slds-p-around_large slds-text-color_success">' +
                            '<strong>No differences found</strong> &mdash; backup matches Salesforce</div>';
                        return;
                    }

                    var html = '<span class="slds-badge slds-badge_success slds-m-bottom_small" style="display:inline-block;">Record exists in ' + data.sandboxName + '</span>' +
                        '<div style="margin-top:0.5rem;margin-bottom:0.5rem;">' +
                        '<button class="slds-button slds-button_neutral slds-button_small" onclick="toggleAllCheckboxes(true)">Select All</button> ' +
                        '<button class="slds-button slds-button_neutral slds-button_small" onclick="toggleAllCheckboxes(false)">Deselect All</button>' +
                        '</div>' +
                        '<table class="slds-table slds-table_cell-buffer slds-table_bordered">' +
                        '<thead><tr>' +
                        '<th style="width:40px;"></th>' +
                        '<th style="width:25%"><div class="slds-truncate">Field</div></th>' +
                        '<th><div class="slds-truncate">Backup Value</div></th>' +
                        '<th><div class="slds-truncate">Current Value</div></th>' +
                        '</tr></thead><tbody>';

                    data.diff.forEach(function(d) {
                        var disabled = d.updateable ? '' : 'disabled';
                        var rowClass = d.updateable ? '' : 'style="opacity:0.5;"';
                        html += '<tr ' + rowClass + '>' +
                            '<td><input type="checkbox" class="restore-field-cb" value="' + d.field + '" ' + disabled + '></td>' +
                            '<td class="slds-text-title_bold">' + d.field + (!d.updateable ? ' <span class="slds-badge" style="font-size:0.65rem;">read-only</span>' : '') + '</td>' +
                            '<td class="diff-added">' + escapeHtml(d.backupValue) + '</td>' +
                            '<td class="diff-removed">' + escapeHtml(d.currentValue) + '</td>' +
                            '</tr>';
                    });

                    html += '</tbody></table>';
                    document.getElementById('compare-modal-body').innerHTML = html;
                    document.getElementById('restore-selected-btn').textContent = 'Restore Selected Fields';
                    document.getElementById('restore-selected-btn').style.display = '';
                } else if (data.inRecycleBin) {
                    // Record is in recycle bin — advise restoring from Salesforce
                    var recycleBinUrl = data.lightningUrl + '/lightning/o/DeleteEvent/list';
                    document.getElementById('compare-modal-body').innerHTML =
                        '<div class="slds-illustration slds-illustration_small slds-p-around_large" style="text-align:center;">' +
                        '<h3 class="slds-text-heading_medium slds-m-bottom_small">Record is in the Recycle Bin</h3>' +
                        '<p>This record is soft-deleted and can be restored directly from Salesforce with its original ID and relationships intact.</p>' +
                        '<p class="slds-m-top_medium"><a href="' + recycleBinUrl + '" target="_blank" class="slds-button slds-button_brand">Open Recycle Bin in Salesforce</a></p>' +
                        '</div>';
                } else {
                    // Record permanently deleted — redirect to Restore with Changes for proper validation
                    var restoreUrl = '/restore?id=' + encodeURIComponent(compareState.recordId) + '&period=' + compareState.period;
                    document.getElementById('compare-modal-body').innerHTML =
                        '<div class="slds-p-around_large" style="text-align:center;">' +
                        '<span class="slds-badge slds-badge_error slds-m-bottom_small" style="display:inline-block;">Record permanently deleted</span>' +
                        '<p class="slds-m-top_small">This record does not exist in the sandbox. Use <strong>Restore with Changes</strong> to review fields, fix invalid lookups, and create a new record.</p>' +
                        '<p class="slds-m-top_medium"><a href="' + restoreUrl + '" class="slds-button slds-button_brand">Open Restore with Changes</a></p>' +
                        '</div>';
                }
            })
            .catch(error => {
                document.getElementById('compare-modal-body').innerHTML =
                    '<div class="slds-notify slds-notify_alert slds-alert_error">Error: ' + error + '</div>';
            });
        }

        function closeCompareModal() {
            document.getElementById('compare-modal').classList.remove('slds-fade-in-open');
            document.getElementById('compare-backdrop').classList.remove('slds-backdrop_open');
        }

        function toggleAllCheckboxes(checked) {
            document.querySelectorAll('.restore-field-cb:not(:disabled)').forEach(function(cb) {
                cb.checked = checked;
            });
        }

        function restoreSelected() {
            if (compareState.recordExists) {
                // Selective restore — collect checked fields
                var fields = [];
                document.querySelectorAll('.restore-field-cb:checked').forEach(function(cb) {
                    fields.push(cb.value);
                });
                if (fields.length === 0) {
                    alert('Select at least one field to restore.');
                    return;
                }
                if (!confirm('Restore ' + fields.length + ' field(s) to existing record?')) return;

                var body = { recordId: compareState.recordId, period: compareState.period, fields: fields };
            } else {
                // Create new — no field selection needed
                if (!confirm('Create new record from backup data?')) return;
                var body = { recordId: compareState.recordId, period: compareState.period };
            }

            document.getElementById('restore-selected-btn').disabled = true;
            document.getElementById('restore-selected-btn').textContent = 'Restoring...';

            fetch('/api/restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('compare-modal-body').innerHTML =
                        '<div class="slds-align_absolute-center slds-p-around_large slds-text-color_success">' +
                        '<strong>Restored successfully!</strong><br>Record ID: ' + data.newId + '</div>';
                    document.getElementById('restore-selected-btn').style.display = 'none';
                    document.getElementById('compare-close-btn').textContent = 'Close';
                } else {
                    var formatted = formatSalesforceError(data.error);
                    var parts = formatted.split('\n\nTip: ');
                    var errHtml = '<div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_small" role="alert">' +
                        '<strong>Restore failed:</strong> ' + escapeHtml(parts[0]) + '</div>';
                    if (parts.length > 1) {
                        errHtml += '<div class="slds-box slds-box_x-small slds-m-bottom_small" style="background:#e8f4fd;border-color:#0070d2;">' +
                            '<p style="color:#0070d2;"><strong>Tip:</strong> ' + escapeHtml(parts[1]) + '</p></div>';
                    }
                    document.getElementById('compare-modal-body').insertAdjacentHTML('afterbegin', errHtml);
                    document.getElementById('restore-selected-btn').disabled = false;
                    document.getElementById('restore-selected-btn').textContent = 'Restore Selected Fields';
                }
            })
            .catch(error => {
                document.getElementById('compare-modal-body').insertAdjacentHTML('afterbegin',
                    '<div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_small" role="alert">' +
                    '<strong>Error:</strong> ' + escapeHtml(String(error)) + '</div>');
                document.getElementById('restore-selected-btn').disabled = false;
                document.getElementById('restore-selected-btn').textContent = 'Restore Selected Fields';
            });
        }

        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }
    </script>
</div>
</body>
</html>
